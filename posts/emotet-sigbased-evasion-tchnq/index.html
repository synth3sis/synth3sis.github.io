<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Emotet: signature-based evasion &amp; malleable executable" /><meta name="author" content="synth3sis" /><meta property="og:locale" content="en_US" /><meta name="description" content="I recently came across an interesting finding concerning Emotet’s infection kill-chain, which usually starts with the phishing email followed by the download of an excel macro then its execution, which acts as the DLL dropper and finally leads to malware infection." /><meta property="og:description" content="I recently came across an interesting finding concerning Emotet’s infection kill-chain, which usually starts with the phishing email followed by the download of an excel macro then its execution, which acts as the DLL dropper and finally leads to malware infection." /><link rel="canonical" href="https://synth3sis.github.io/posts/emotet-sigbased-evasion-tchnq/" /><meta property="og:url" content="https://synth3sis.github.io/posts/emotet-sigbased-evasion-tchnq/" /><meta property="og:site_name" content="Synth3sis Papers" /><meta property="og:image" content="https://synth3sis.github.io/post-emotet.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-01T11:29:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://synth3sis.github.io/post-emotet.png" /><meta property="twitter:title" content="Emotet: signature-based evasion &amp; malleable executable" /><meta name="twitter:site" content="@snth3s" /><meta name="twitter:creator" content="@synth3sis" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"synth3sis"},"dateModified":"2022-04-12T17:31:35+00:00","datePublished":"2022-04-01T11:29:00+00:00","description":"I recently came across an interesting finding concerning Emotet’s infection kill-chain, which usually starts with the phishing email followed by the download of an excel macro then its execution, which acts as the DLL dropper and finally leads to malware infection.","headline":"Emotet: signature-based evasion &amp; malleable executable","image":"https://synth3sis.github.io/post-emotet.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://synth3sis.github.io/posts/emotet-sigbased-evasion-tchnq/"},"url":"https://synth3sis.github.io/posts/emotet-sigbased-evasion-tchnq/"}</script><title>Emotet: signature-based evasion & malleable executable | Synth3sis Papers</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Synth3sis Papers"><meta name="application-name" content="Synth3sis Papers"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-SFXK2NQNYV"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SFXK2NQNYV'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Synth3sis Papers</a></div><div class="site-subtitle font-italic">Security researches and red-blue-purple tips out of my experience and study</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/synth3sis" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/snth3s" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['synth3sis.git','protonmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Emotet: signature-based evasion & malleable executable</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Emotet: signature-based evasion & malleable executable</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> synth3sis </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Apr 1, 2022, 11:29 AM +0000" prep="on" > Apr 1 <i class="unloaded">2022-04-01T11:29:00+00:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Apr 12, 2022, 7:31 PM +0200" prefix="Updated " > Apr 12 <i class="unloaded">2022-04-12T17:31:35+00:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1273 words">7 min</span></div><div><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@synth3sis"></div></div><div class="post-content"><p>I recently came across an interesting finding concerning Emotet’s infection kill-chain, which usually starts with the phishing email followed by the download of an excel macro then its execution, which acts as the DLL dropper and finally leads to malware infection.</p><h2 id="signature">Signature</h2><p>I had a look inside the malicious excel document. The dropper had an incorporated list of domains to grab the malware from, in order to increase the download chances if one or more of them were to be eventually unreachable.</p><p>Here are the URLs I found inside the document’s <code class="language-plaintext highlighter-rouge">xl/sharedStrings.xml</code> file:</p><p><img src="/assets/img/202204/S0367-emt-sharedstrings.png" alt="S0367-emt-sharedstrings" class="center" width="60%" height="60%" /></p><p>Almost every one of them was reachable and serving the executable.</p><p>Once downloaded the sample I started to look for as many IOCs as possible, so I noticed it had a unique hash signature. I fed it to Virus Total, which took its time to digest the sample (it was a new one!) and then gave me a malicious score of 49 out of 69, so no worries.</p><p><img src="/assets/img/202204/S0367-emt-vt.png" alt="S0367-emt-vt" class="center" /></p><p>The interesting part was actually the methodology implemented by threat actors to evade the signature-based detection. I double checked every one of them to catch indicators, and I noticed that every time I downloaded the DLL, it had a different hash so I grubbed two more, all of which had the same size (#IOCs).</p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span><span class="nb">sha256sum</span> <span class="k">*</span>.dll
<span class="go">d676b92e998dd3c2dfb6e51f8218019347c8b77d621fbf105fae3f7d7e2cb829  X7Nwjq.dll
7a11140df855a04f149152da55819c4a18ded6eff3eaf09cb80332cf24343b42  FHTz6WZe2JM.dll
d91fa3bfa7ea9265375b4f89100c54900f083daa115f025203121091a950afc6  B5tcHyPEujNbv.dll

</span><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span><span class="nb">du</span> <span class="nt">-sb</span> <span class="k">*</span>.dll
<span class="go">626688  X7Nwjq.dll
626688  FHTz6WZe2JM.dll
626688  B5tcHyPEujNbv.dll

</span></pre></table></code></div></div><p>Then, I analyzed the differences among their HEX dump and here is what I found:</p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span>diff X7Nwjq.dll.xxd FHTz6WZe2JM.dll.xxd
<span class="go">20799,20801c20799,20801
&lt; 00052430  00 00 00 00 00 00 00 00  31 00 00 00 ee b1 51 09  |........1.....Q.|
&lt; 00052440  04 2b d8 a4 bf cf a8 b7  b0 45 5d 86 a3 60 4a 6b  |.+.......E]..`Jk|
</span><span class="gp">&lt; 00052450  63 54 45 82 cf 33 3e eb  0b ab 0f b8 00 00 00 00  |cTE..3&gt;</span>.........|
<span class="go">---
</span><span class="gp">&gt;</span><span class="w"> </span>00052430  00 00 00 00 00 00 00 00  31 00 00 00 4e f6 a8 65  |........1...N..e|
<span class="gp">&gt;</span><span class="w"> </span>00052440  69 93 98 3f a7 <span class="nb">fc </span>31 0b  1f c6 7e 58 96 45 78 6c  |i..?..1...~X.Exl|
<span class="gp">&gt;</span><span class="w"> </span>00052450  b7 5a 62 8b da 4b a2 a5  <span class="nb">df </span>56 f0 22 00 00 00 00  |.Zb..K...V.<span class="s2">"....|
</span></pre></table></code></div></div><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">#</span><span class="w"> </span>B5tcHyPEujNbv.dll:
<span class="gp">&gt;</span><span class="w"> </span>00052430  00 00 00 00 00 00 00 00  31 00 00 00 48 bb 9a 0f  |........1...H...|
<span class="gp">&gt;</span><span class="w"> </span>00052440  54 44 07 cb f5 4f c6 b1  e6 e8 3c 22 22 37 <span class="nb">cd </span>fb  |TD...O....&lt;<span class="s2">""</span>7..|
<span class="gp">&gt;</span><span class="w"> </span>00052450  99 8e 6a d4 3a 20 f6 24  c8 bd 12 c8 00 00 00 00  |..j.: .<span class="nv">$.</span>.......|
</pre></table></code></div></div><p>It appears that at offset <code class="language-plaintext highlighter-rouge">5243C</code> they show variations, more precisely exactly 32 bytes vary (until <code class="language-plaintext highlighter-rouge">5245B</code> included), which at first sight it seemed randomly generated and lacking relevant information.</p><p>Analyzing the PE’s entropy, as expected, <code class="language-plaintext highlighter-rouge">.text</code> and <code class="language-plaintext highlighter-rouge">.rdata</code> sections are packed:</p><p><img src="/assets/img/202204/S0367-emt-entropy.png" alt="S0367-emt-entropy" class="center" /></p><h2 id="executable-sequence">Executable’ sequence</h2><p>I wondered what was the technical mechanism behind this interesting behaviour and how could be implemented, so I started doing some research and I came across the concept of <a href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/malleable-c2-extend_main.htm#_Toc65482852"><strong>Cobalt Strike Malleable PEs</strong></a> which gave me some insight on C2 agents and malleable PE configurations.</p><p>Regardless, my goal was to write a piece of code to give me proof on how I could modify some section of the package in response to a web request and eventually embed configurations in it. In other words, <strong>without having to re-compile the source code every time</strong>. The thing about this stuff was that potentially this PE, once deployed could have been sent all over the network without being detected by signature-based detection systems, such as basic AVs or NIDS/NIPS of some sort.</p><p>At this point I did further research and studies just to be able to reproduce this mechanism by writing the right program and create my basic proof of concept.</p><p>So, I wrote a C++ sample which implements a static pre-allocated buffer used to keep track of the sequence to be later editable. I used the same <code class="language-plaintext highlighter-rouge">X7Nwjq.dll</code> byte array so I disposed exactly 32 bytes for it.</p><p>What it does is:</p><ol><li>Allocate a 32 static buffer<li>Dump the sequence to <code class="language-plaintext highlighter-rouge">sequence.bin</code> file<li>Print out confirmation</ol><p>Here is <code class="language-plaintext highlighter-rouge">seqdumper.cpp</code> code:</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sequence_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span>
    <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xBF</span><span class="p">,</span> <span class="mh">0xCF</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span>
    <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xCF</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0xB8</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">outfile</span><span class="p">;</span>
    <span class="n">outfile</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"sequence.bin"</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios_base</span><span class="o">::</span><span class="n">binary</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"+ writing down "</span> <span class="o">&lt;&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sequence_buf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">" bytes sequence_buf</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="c1">// write down byte by byte to avoid extra ones to be dumped at the end</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sequence_buf</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">outfile</span><span class="p">.</span><span class="n">write</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)(</span><span class="n">sequence_buf</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sequence_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sequence_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"+ </span><span class="se">\"</span><span class="s">sequence.bin</span><span class="se">\"</span><span class="s"> dumped</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">outfile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Then compiled and ran it.</p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span>g++ seqdumper.cpp <span class="nt">-o</span> agent <span class="o">&amp;&amp;</span> ./agent
<span class="go">+ writing down 32 bytes sequence
+ "sequence.bin" dumped

</span><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span>xxd sequence.bin
<span class="go">00000000: eeb1 5109 042b d8a4 bfcf a8b7 b045 5d86  ..Q..+.......E].
</span><span class="gp">00000010: a360 4a6b 6354 4582 cf33 3eeb 0bab 0fb8  .`JkcTE..3&gt;</span>.....
</pre></table></code></div></div><p>The same sequence is embedded in <code class="language-plaintext highlighter-rouge">agent</code>, more precisely in this case at offset <code class="language-plaintext highlighter-rouge">30a0</code>.</p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span>xxd agent |grep <span class="nt">-A1</span> <span class="s2">"eeb1"</span>
<span class="go">000030a0: eeb1 5109 042b d8a4 bfcf a8b7 b045 5d86  ..Q..+.......E].
</span><span class="gp">000030b0: a360 4a6b 6354 4582 cf33 3eeb 0bab 0fb8  .`JkcTE..3&gt;</span>.....
</pre></table></code></div></div><h2 id="malleable-executable">Malleable executable</h2><p>Once I got the <em>address</em>, I developed a python script to overwrite, or <strong>patch</strong>, exactly that sequence.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"Usage: python3 patchbin.py /path/to/binfile"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">sys</span><span class="p">.</span><span class="nb">exit</span><span class="p">(</span><span class="s">"File does not exists"</span><span class="p">)</span>

    <span class="nb">execfile</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">patch</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"'7h475_7h3_N3w_''53qu3nc_1nj3c7'"</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">execfile</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">ef</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">ef</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">ef</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Look for the sequence's first 4 bytes
</span>    <span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\xee\xb1\x51\x09</span><span class="s">"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"-&gt; Patching file at offset "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">execfile</span><span class="p">,</span> <span class="s">'r+b'</span><span class="p">)</span> <span class="k">as</span> <span class="n">ef</span><span class="p">:</span>
        <span class="n">ef</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">ef</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
    <span class="n">ef</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"-&gt; "</span> <span class="o">+</span> <span class="nb">execfile</span> <span class="o">+</span> <span class="s">" patched"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></table></code></div></div><p>Finally, I executed <code class="language-plaintext highlighter-rouge">agent</code> which dropped its sequence to <code class="language-plaintext highlighter-rouge">sequence.bin</code> binary file.</p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span>./agent
<span class="go">+ writing down 32 bytes sequence
+ "sequence.bin" dumped

</span><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span><span class="nb">cat </span>sequence.bin |xxd
<span class="go">00000000: eeb1 5109 042b d8a4 bfcf a8b7 b045 5d86  ..Q..+.......E].
</span><span class="gp">00000010: a360 4a6b 6354 4582 cf33 3eeb 0bab 0fb8  .`JkcTE..3&gt;</span>.....
<span class="go">
</span><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span>sha256 agent
<span class="go">fd19322c68ba5bbf6ddae23b7a60ad760620d9aafef1f678ca49a7b945e95faf  agent
</span></pre></table></code></div></div><p>Then patched the executable.</p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span>./patchbin.py agent
<span class="gp">-&gt;</span><span class="w"> </span>Patching file at offset 12448
<span class="gp">-&gt;</span><span class="w"> </span>agent patched
<span class="go">
</span><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span><span class="nb">sha256sum </span>agent
<span class="go">82e359b8cf4108b9dfc4367ba46a09be98874b1260406035aa4a84ae0d0d16b4  agent
</span></pre></table></code></div></div><p>The executable’s signature has changed. When executed, it dumps the patched byte array we set.</p><div class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span>./agent
<span class="go">+ writing down 32 bytes sequence
+ "sequence.bin" dumped

</span><span class="gp">(synth3sis㉿sthsvm)-[~/Emotet]$</span><span class="w"> </span><span class="nb">cat </span>sequence.bin |xxd
<span class="go">00000000: 2737 6834 3735 5f37 6833 5f4e 3377 5f27  '7h475_7h3_N3w_'
00000010: 2735 3371 7533 6e63 5f31 6e6a 3363 3727  '53qu3nc_1nj3c7'
</span></pre></table></code></div></div><p><br /></p><hr /><hr /><p><br /> If any other idea about this case of study comes to mind, I will update it so stay tuned! And feel free to contact me if you have any advice regarding my work.</p><p>In the next write-up I will further deepen the subject to see if I can manage to embed structured informations useful for configuration with a PoC of client-server communication.</p><p>More content coming soon!</p></div><script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="synt3sis" data-description="Support me on Buy me a coffee!" data-message="If you like this content and would like to see more, please consider buying me a coffee!" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/researches/'>Researches</a>, <a href='/categories/malware/'>Malware</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/dropper/" class="post-tag no-text-decoration" >dropper</a> <a href="/tags/dll/" class="post-tag no-text-decoration" >dll</a> <a href="/tags/malleable/" class="post-tag no-text-decoration" >malleable</a> <a href="/tags/infection/" class="post-tag no-text-decoration" >infection</a> <a href="/tags/executable/" class="post-tag no-text-decoration" >executable</a> <a href="/tags/evasion/" class="post-tag no-text-decoration" >evasion</a> <a href="/tags/emotet/" class="post-tag no-text-decoration" >emotet</a> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/analysis/" class="post-tag no-text-decoration" >analysis</a> <a href="/tags/xxd/" class="post-tag no-text-decoration" >xxd</a> <a href="/tags/hex/" class="post-tag no-text-decoration" >hex</a> <a href="/tags/c/" class="post-tag no-text-decoration" >c++</a> <a href="/tags/ioc/" class="post-tag no-text-decoration" >ioc</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Emotet: signature-based evasion & malleable executable - Synth3sis Papers&url=https://synth3sis.github.io/posts/emotet-sigbased-evasion-tchnq/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Emotet: signature-based evasion & malleable executable - Synth3sis Papers&u=https://synth3sis.github.io/posts/emotet-sigbased-evasion-tchnq/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Emotet: signature-based evasion & malleable executable - Synth3sis Papers&url=https://synth3sis.github.io/posts/emotet-sigbased-evasion-tchnq/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/emotet-sigbased-evasion-tchnq/">Emotet: signature-based evasion & malleable executable</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/analysis/">analysis</a> <a class="post-tag" href="/tags/c/">c++</a> <a class="post-tag" href="/tags/dll/">dll</a> <a class="post-tag" href="/tags/dropper/">dropper</a> <a class="post-tag" href="/tags/emotet/">emotet</a> <a class="post-tag" href="/tags/evasion/">evasion</a> <a class="post-tag" href="/tags/executable/">executable</a> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hex/">hex</a> <a class="post-tag" href="/tags/infection/">infection</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <script src="https://utteranc.es/client.js" repo="synth3sis/synth3sis.github.io" issue-term="title" label="comments 💬" theme="github-dark" crossorigin="anonymous" async> </script><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/synth3sis">Synth3sis</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/analysis/">analysis</a> <a class="post-tag" href="/tags/c/">c++</a> <a class="post-tag" href="/tags/dll/">dll</a> <a class="post-tag" href="/tags/dropper/">dropper</a> <a class="post-tag" href="/tags/emotet/">emotet</a> <a class="post-tag" href="/tags/evasion/">evasion</a> <a class="post-tag" href="/tags/executable/">executable</a> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/hex/">hex</a> <a class="post-tag" href="/tags/infection/">infection</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://synth3sis.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
